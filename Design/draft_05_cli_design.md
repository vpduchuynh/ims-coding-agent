## 5. Command Line Interface (CLI) Design

This section details the design of the Command Line Interface (CLI) for the PT-CLI application. The CLI serves as the primary user interface (IF-UI-001) and is designed for usability by proficiency testing providers and statisticians familiar with command-line tools (User Characteristics 2.3, NFR-US-001). It will be implemented using the `Typer` library in Python (FR-CLI-001), providing features like automatic help generation (FR-CLI-005), type checking, and clear argument/option definition (FR-CLI-003).

### 5.1 CLI Structure (Sub-commands)

The CLI will be organized using Typer sub-commands to provide distinct functionalities (FR-CLI-002). The main entry point will be `pt-cli` (or similar, depending on packaging). The following sub-commands will be implemented:

*   **`pt-cli calculate`**: The primary command for performing a full analysis run. It takes input data, applies configuration, runs the Rust calculation engine to determine `x_pt`, `u(x_pt)`, and scores, and finally generates a report using Quarto.
*   **`pt-cli validate-data`**: A utility command focused solely on validating an input data file against the expected structure and types defined by the configuration. It loads the data and configuration, performs validation using `data_io.py`, and reports the results (success or specific errors) to the console via `rich`.
*   **`pt-cli generate-report-only`**: A command to generate a report using Quarto based on pre-existing calculation results. This requires a defined way to provide these results (e.g., via an intermediate JSON file generated by a previous `calculate` run or passed through specific arguments). This allows users to re-generate reports in different formats or with different templates without re-running the potentially time-consuming calculations.

### 5.2 Argument and Option Specification (FR-CLI-004)

Each sub-command will accept specific arguments and options, defined using Typer decorators and type hints for clarity and validation. Common options might be defined at the top level or repeated where necessary.

**Common Options (Potentially applicable to multiple commands):**

*   `--config`, `-c`: `Optional[Path]` = Argument(None, help="Path to the configuration file (YAML or TOML). Uses defaults if not provided.") (FR-CM-001)
*   `--verbose`, `-v`: `bool` = Option(False, help="Enable verbose output to the console.")

**`pt-cli calculate` Arguments and Options:**

*   `input_file`: `Path` = Argument(..., exists=True, file_okay=True, readable=True, help="Path to the input data file (CSV or XLSX).") (FR-DI-001)
*   `--output-report`, `-o`: `Path` = Option("report", help="Base path and filename for the output report (extension added automatically).") (FR-RP-004)
*   `--output-format`, `-f`: `str` = Option("pdf", help="Format for the output report (e.g., pdf, html, docx).") (FR-RP-004)
*   `--method`: `Optional[str]` = Option(None, help="Override the assigned value calculation method specified in the config (e.g., AlgorithmA, CRM).") (FR-AV-006)
*   `--sigma-pt`: `Optional[float]` = Option(None, help="Override the standard deviation for proficiency assessment (sigma_pt).") (FR-PS-003)
*   `--results-json`: `Optional[Path]` = Option(None, help="Optional path to save intermediate calculation results as a JSON file.")

**`pt-cli validate-data` Arguments and Options:**

*   `input_file`: `Path` = Argument(..., exists=True, file_okay=True, readable=True, help="Path to the input data file (CSV or XLSX) to validate.")
*   `--config`, `-c`: (As above)

**`pt-cli generate-report-only` Arguments and Options:**

*   `results_input`: `Path` = Argument(..., exists=True, file_okay=True, readable=True, help="Path to the file containing pre-calculated results (e.g., JSON generated by 'calculate').")
*   `--output-report`, `-o`: (As above)
*   `--output-format`, `-f`: (As above)
*   `--config`, `-c`: (As above, needed for template path etc.)

Typer will automatically generate help messages (e.g., via `pt-cli calculate --help`) based on these definitions, fulfilling FR-CLI-005 and contributing to usability (NFR-US-002).

### 5.3 Example Usage Scenarios

To illustrate how a user would interact with the CLI:

1.  **Basic Calculation Run (using defaults):**
    ```bash
    pt-cli calculate path/to/participant_data.xlsx
    ```
    *(This assumes a default config exists or is not needed, runs Algorithm A if default, outputs `report.pdf`)*

2.  **Calculation with Specific Config and Output:**
    ```bash
    pt-cli calculate data.csv --config my_config.yaml -o round_1_analysis -f html
    ```
    *(Uses `my_config.yaml`, outputs `round_1_analysis.html`)*

3.  **Overriding Calculation Method and Sigma PT:**
    ```bash
    pt-cli calculate results.xlsx --method CRM --sigma-pt 0.5 -o crm_report.pdf
    ```
    *(Forces CRM method, uses sigma_pt=0.5, outputs `crm_report.pdf`)*

4.  **Saving Intermediate Results:**
    ```bash
    pt-cli calculate data.csv --config my_config.yaml --results-json calc_results.json
    ```
    *(Runs calculation and saves results to `calc_results.json` in addition to the report)*

5.  **Validating Data Only:**
    ```bash
    pt-cli validate-data new_data_upload.csv --config validation_rules.toml
    ```
    *(Checks `new_data_upload.csv` against rules in `validation_rules.toml`, prints status to console)*

6.  **Generating a Report from Saved Results:**
    ```bash
    pt-cli generate-report-only calc_results.json -o final_report -f docx --config report_config.yaml
    ```
    *(Uses results from `calc_results.json` and settings from `report_config.yaml` to create `final_report.docx`)*

7.  **Getting Help:**
    ```bash
    pt-cli --help
    pt-cli calculate --help
    ```

This CLI design provides a flexible and user-friendly interface (NFR-US-001, NFR-US-002) for accessing the different functionalities of the PT-CLI application, ensuring all required operations and configurations are accessible (FR-CLI-004) and providing clear feedback (FR-CLI-006).
